<html>
  <head>
    <!-- Remote style sheet -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="Personal-Finance-UI/Personal-Finance.css" />

    <script src="Personal-Finance-UI/Personal-Finance.js"></script>
  </head>

  <body>
    <script>
      function GET(range) {
        var params = {
          spreadsheetId: "1pBKRb0FbUj2Tf4y99OqF6tRvrUDVVrbKltkUekNoQnY",
          range: getCurrentMonth() + range,
          valueRenderOption: "FORMATTED_VALUE",
          dateTimeRenderOption: "SERIAL_NUMBER",
        };

        var request = gapi.client.sheets.spreadsheets.values.get(params);
        request.then(function (response) {
          return response;
        });
      }

      function getAllCategories() {
        var catNum = countCategories();
        var categories = GET("!N23:N" + (23 + catNum));
      }

      function countCategories() {
        var response = GET("!N23:N");
        for (var i = 0; i < response.result.values.length; i++) {
          if (response.result.values[i] == "") {
            return i;
          }
        }
      }

      function loadInCategories() {
        var response = getAllCategories();
        for (var i = 0; i < response.result.values.length; i++) {
          document.getElementById("transactionCategories").innerHTML +=
            "<a class='dropdown-item' href='#'>" +
            response.result.value[i].text +
            "</a>";
        }
      }

      function getFirstEmptyCell(response) {
        for (var i = 0; i < response.result.values.length; i++) {
          if (response.result.values[i] == "") {
            return i;
          }
        }
      }

      function submitExtraSpending() {
        // Get First Empty Cell
        var extraSpendingValues = GET("!I4:I");
        var emptyCell = getFirstEmptyCell(extraSpendingValues);

        // Get Input Values
      }

      function getUserInput() {
        var title = document.getElementById("transactionTitle").value;
        var amount = document.getElementById("transactionAmount").value;
        // var category = document.getElementById("transactionCategories").value;
        var category = $("transactionCategories option:selected").text();
      }

      function makeApiCall() {
        var params = {
          spreadsheetId: "1pBKRb0FbUj2Tf4y99OqF6tRvrUDVVrbKltkUekNoQnY",
          range: getCurrentMonth() + "!I4:I",
          valueRenderOption: "FORMATTED_VALUE",
          dateTimeRenderOption: "SERIAL_NUMBER",
        };

        var request = gapi.client.sheets.spreadsheets.values.get(params);
        request.then(
          function (response) {
            for (var i = 0; i < response.result.values.length; i++) {
              if (response.result.values[i] == "") {
                var values = [["Testing", "0", "Test"]];
                var body = { values: values };
                writeToSpreadsheet(
                  getCurrentMonth() + "!I" + (i + 4) + ":K" + (i + 4),
                  body
                );
                break;
              }
            }
          },
          function (reason) {
            console.error("error: " + reason.result.error.message);
          }
        );
      }

      function writeToSpreadsheet(rangeValue, updateValues) {
        var params = {
          spreadsheetId: "1pBKRb0FbUj2Tf4y99OqF6tRvrUDVVrbKltkUekNoQnY",
          range: rangeValue,
          valueInputOption: "RAW",
          resource: updateValues,
        };

        var request = gapi.client.sheets.spreadsheets.values.update(params);
        request.then(
          function (response) {
            alert("done!");
          },
          function (reason) {
            //console.error("error: " + reason.result.error.message);
          }
        );
      }

      // function makeApiCall() {
      //   getCurrentMonth();
      //   var params = {
      //     // The ID of the spreadsheet to retrieve data from.
      //     spreadsheetId: "1pBKRb0FbUj2Tf4y99OqF6tRvrUDVVrbKltkUekNoQnY", // TODO: Update placeholder value.

      //     // The A1 notation of the values to retrieve.
      //     range: getCurrentMonth + "!I4", // TODO: Update placeholder value.

      //     // How values should be represented in the output.
      //     // The default render option is ValueRenderOption.FORMATTED_VALUE.
      //     valueRenderOption: "FORMATTED_VALUE", // TODO: Update placeholder value.

      //     // How dates, times, and durations should be represented in the output.
      //     // This is ignored if value_render_option is
      //     // FORMATTED_VALUE.
      //     // The default dateTime render option is [DateTimeRenderOption.SERIAL_NUMBER].
      //     dateTimeRenderOption: "SERIAL_NUMBER", // TODO: Update placeholder value.
      //   };

      //   var request = gapi.client.sheets.spreadsheets.values.get(params);
      //   request.then(
      //     function (response) {
      //       // TODO: Change code below to process the `response` object:
      //       console.log(response.result);
      //       document.getElementById("result").innerHTML =
      //         response.result.values[0];
      //     },
      //     function (reason) {
      //       console.error("error: " + reason.result.error.message);
      //     }
      //   );
      // }

      function initClient() {
        var API_KEY = "AIzaSyBUSb77wnD1w3D7fdbMXo64ua9dPJuDwpE"; // TODO: Update placeholder with desired API key.

        var CLIENT_ID =
          "370031703270-tm2mcop58igvn24iqeup3glfoa3gk3it.apps.googleusercontent.com"; // TODO: Update placeholder with desired client ID.

        // TODO: Authorize using one of the following scopes:
        //   'https://www.googleapis.com/auth/drive'
        //   'https://www.googleapis.com/auth/drive.file'
        //   'https://www.googleapis.com/auth/drive.readonly'
        //   'https://www.googleapis.com/auth/spreadsheets'
        //   'https://www.googleapis.com/auth/spreadsheets.readonly'
        var SCOPE = "https://www.googleapis.com/auth/spreadsheets";

        gapi.client
          .init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            scope: SCOPE,
            discoveryDocs: [
              "https://sheets.googleapis.com/$discovery/rest?version=v4",
            ],
          })
          .then(function () {
            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);
            updateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
          });
      }

      function handleClientLoad() {
        gapi.load("client:auth2", initClient);
      }

      function updateSignInStatus(isSignedIn) {
        if (isSignedIn) {
          loadInCategories();
        }
      }

      function handleSignInClick(event) {
        gapi.auth2.getAuthInstance().signIn();
      }

      function handleSignOutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
      }

      // Custom Functions

      function getCurrentMonth() {
        const months = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];
        let date = new Date();
        let currentMonth = months[date.getMonth()];

        return currentMonth;
      }
    </script>
    <script
      async
      defer
      src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()"
    ></script>

    <!-- Transaction Title -->
    <div class="row justify-content-center">
      <input
        type="text"
        id="transactionTitle"
        placeholder="Transaction Title"
      />
      <!-- Transaction Amount -->
      <input
        type="number"
        id="transactionAmount"
        min="0.00"
        step="0.01"
        max="100000"
        placeholder="$"
      />
      <!-- Transaction Categories -->
      <div class="dropdown" id="transactionCategories">
        <button
          class="btn btn-secondary dropdown-toggle"
          type="button"
          id="dropdownMenuButton"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
        >
          Dropdown button
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          <a class="dropdown-item" href="#">Action</a>
          <a class="dropdown-item" href="#">Another action</a>
          <a class="dropdown-item" href="#">Something else here</a>
        </div>
      </div>
    </div>

    <button id="btnSubmit" onclick="submitExtraSpending()">Submit</button>

    <!-- Sign In & Out Buttons -->
    <div class="row justify-content-center" id="signInButtons">
      <div class="col justify-content-center">
        <button id="signin-button" onclick="handleSignInClick()">
          Sign in
        </button>
        <button id="signout-button" onclick="handleSignOutClick()">
          Sign out
        </button>
      </div>
    </div>
  </body>
</html>
